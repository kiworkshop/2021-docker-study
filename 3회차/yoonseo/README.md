# 도커 네트워크

컨테이너를 위한 SDN(Software-Defined Network)

도커 컨테이너는 네트워크로 연결하는 대상이 도커 워크로드인지 유무에 상관 없이 연결 할 수 있기 때문에 강력하다.

## 네트워크 드라이버

도커 네트워크 시스템은 드라이버를 사용해 연결할 수 있다.

- bridge : 기본 네트워크 드라이버. 동일한 호스트에 있는 컨테이너끼리 통신할 때 사용한다.
- host : 독립 컨테이너와 도커 호스트와 격리를 제거하고 호스트 네트워크를 직접 사용한다.
- overlay: 여러 도커 데몬을 함께 연결하고 스웜 서비스가 서로 통신할 수 있도록 한다. 서로 다른 도커 데몬에 있는 컨테이너끼리 통신할 수 있도록 한다.
- macvlan: 컨테이너에 MAC주소를 할당해 네트워크에서 물리적 장치로 표시할 수 있다. 도커 데몬은 MAC주소로 라우팅을 한다.
- none: 모든 네트워크를 비활성화한다.
- network plugin: 써드파티 네트워크 플러그인을 사용할 수 있다.

## Bridge Network

네트워크 측면에서, bridge 네트워크는 세그먼트를 전송하는 Link Layer 디바이스이다. 호스트 머신의 커널에서 하드웨어 디바이스가 될 수도 있고 소프트웨어 디바이스가 될 수도 있다.

도커 측면에서, bridge 네트워크는 같은 bridge를 사용하는 컨테이너끼리 통신할 수 있도록 하고 bridge에 연결되어 있지 않은 컨테이너로부터 격리한다.

도커를 시작하면 bridge 네트워크가 기본으로 생성되고 별도로 지정하지 않으면 새로 시작한 컨테이너가 여기에 연결된다. 커스텀 bridge 네트워크를 만들 수 도 있다. 사용자 정의 bridge 네트워크는 성능면에서 기본 bridge 네트워크보다 우수하다.

### 사용자 정의 bridge vs 기본 bridge

- 사용자 정의 bridge는 컨테이너 간에 자동으로 DNS를 확인한다.
    - 기본 bridge 네트워크에선 컨테이너끼리 IP 주소로만 접근할 수 있다.
    반면 사용자 정의 bridge 네트워크에선 컨테이너끼리 이름이나 별칭으로도 접근할 수 있다.
    - 기본 bridge 네트워크에선 애플리케이션 스택(was + db)을 실행할 때 수동으로 링크를 생성해야 한다. (`—-link` 사용)
- 사용자 정의 bridge에선 더 나은 격리를 제공한다.
    - 모든 컨테이너에선 `-—network`를 지정하지 않으면 기본 bridge 네트워크를 사용한다. 이렇게 되면 관련 없는 스택이나 서비스, 컨테이너끼리 통신할 수 있기 때문에 위험하다.
- 컨테이너는 사용자 정의 bridge 네트워크에서 즉시 연결 및 분리할 수 있다.
    - 컨테이너 라이프사이클 동안 사용자 정의 네트워크에서 즉시 연결하거나 끊을 수 있다.
    반면 기본 bridge 네트워크에선 컨테이너를 중지하고 다른 네트워크 옵션으로 다시 생성해야한다.
- 각각의 사용자 정의 bridge 네트워크는 별도의 설정이 가능하다.
    - 기본 bridge 네트워크는 MTU, iptables같이 동일한 설정을 사용한다.
    - 사용자 정의 네트워크는 `docker network create`를 사용해 생성 및 구성되기 때문에 애플리케이션 그룹마다 별도로 설정할 수 있다.
- 기본 bridge 네트워크는 환경변수를 공유한다.
    - 여러 컨테이너는 도커 볼륨을 사용해 공유 정보가 포함된 파일이나 디렉토리를 마운트할 수 있다.
    - 여러 컨테이너를 함께 시작할 수 있고 docker-compose 작성 파일은 공유 변수를 정의할 수 있다.
    - 도커 스웜을 사용해 공유 secret 및 설정을 사용할 수 있다.
- 사용자 정의 bridge 네트워크는 연결된 컨테이너끼리 서로 노출한다. 포트를 다른 네트워크로 노출하려면 `-p` 또는 `—publish를` 사용해야 한다.

# 서비스 디스커버리

새로 생성된 컨테이너나 없어진 컨테이너를 감지하는 기술이다. 일반적으로 zookeeper, etcd등 분산 코디네이터를 외부에 두어서 사용한다.

도커 스웜은 자체적으로 서비스 디스커버리를 지원한다. 스웜에선 overlay 네트워크를 사용하면 서비스 이름을 통해 해당 컨테이너에 접근한다.

서비스 디스커버리 기능은 register 기능과 lookup 기능으로 구성된다.

컨테이너 스케줄링과 서비스 디스커버리는 서로 필요한 존재.

# Docker Compose

다중 컨테이너 도커 애플리케이션을 실행하기 위한 도구이다. 여러 컨테이너를 하나의 애플리케이션으로 관리할 수 있다.

Compose는 3단계로 실행된다.

1. Dockerfile에 애플리케이션의 환경을 정의한다.
2. docker-compose.yml에 애플리케이션을 구성하는 서비스를 정의한다. 이 서비스들은 격리된 환경에서 함께 실행할 수 있다.
3. docker compose up을 통해 전체 애플리케이션을 실행한다.

## 기능

### 단일 호스트에서 다중 격리된 환경

Compose는 프로젝트 이름을 사용해서 환경을 격리한다. 여러 컨텍스트에서 프로젝트 이름을 사용할 수 있다.

기본 프로젝트 이름은 프로젝트 디렉토리 이름이다. `-p` 옵션이나 `COMPOSE_PROJECT_NAME` 환경변수를 사용해 프로젝트 이름을 설정할 수 있다.

기본 프로젝트 디렉토리는 컴포즈 파일이 있는 디렉토리 이름이다. `—project-directory` 옵션을 통해 변경할 수 있다.

### 컨테이너가 생성될 때 볼륨 데이터를 보존

Compose는 서비스에서 사용되는 모든 볼륨을 보존할 수 있다. docker-compose up을 실행하면 이전에 실행했던 컨테이너를 찾아서 볼륨을 복사하고 새 컨테이너로 복사한다. 이 과정을 통해 볼륨 데이터를 잃지 않는다.

### 오직 변경된 컨테이너만 재생성

Compose는 컨테이너를 만드는데 사용된 설정을 캐시한다. 컨테이너 환경 변경시 기존 컨테이너를 재사용해 빠르게 동작한다.

### 변수 및 환경 간 설정 이동

Compose 파일의 변수를 통해 다양한 환경에 맞게 설정할 수 있다. `extends` 필드를 사용해 작성 파일을 확장할 수 있다.

## Compose 네트워크

서비스 내의 각 컨테이너는 기본 네트워크에 연결된다. 네트워크 내의 다른 컨테이너에서 접근할 수 있고 컨테이너 이름을 통해 식별된다.

애플리케이션의 네트워크는 기본적으로 프로젝트 이름으로 생성된다.

`myapp` 디렉토리에서 `docker-compose.yml`을 작성해서 실행하면 다음과 같이 동작한다.

```yaml
version: "3.9"
services: 
	web: 
		build: .
		ports: 
			- "8000:8000"
	db: 
		image: postgres
		ports: 
			- "8001:5432"
```

1. `myapp_default` 네트워크가 생성된다.
2. `web` 설정을 통해 컨테이너가 생성된다. `web` 컨테이너는 `myapp_default` 네트워크에 연결된다.
3. `db` 설정을 통해 컨테이너가 생성된다. `db` 컨테이너도 `myapp_default` 네트워크에 연결된다.

아래 발표 주제들에 대하여 학습하고 싶은 데까지 자유롭게 학습하고, 자유로운 양식으로 발표를 준비해 봅시다.

- 도커 네트워크와 서비스 디스커버리
- Docker compose의 프로젝트, 서비스, 컨테이너. Docker compose 네트워크
- [pinpoint docker compose 리버스 엔지니어링](https://github.com/pinpoint-apm/pinpoint-docker)
- [prometheus docker compose 리버스 엔지니어링](https://github.com/vegasbrianc/prometheus)